"use client";

import React from "react"

import { useState } from "react";
import { cn } from "@/lib/utils";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import {
  Server,
  Network,
  FileCode,
  Layers,
  Shield,
  AlertTriangle,
  CheckCircle2,
  XCircle,
  ChevronRight,
} from "lucide-react";

// Types for the security taxonomy
interface AttackVector {
  id: string;
  name: string;
  severity: "Critical" | "High" | "Medium" | "Low";
  description: string;
  example?: string;
  mitigations: string[];
}

interface SecurityLayer {
  id: string;
  name: string;
  description: string;
  icon: React.ReactNode;
  color: string;
  bgColor: string;
  borderColor: string;
  attacks: AttackVector[];
}

// Security data based on the research paper content
const securityLayers: SecurityLayer[] = [
  {
    id: "application",
    name: "Application Layer",
    description: "Smart contracts, dApps, and user interfaces",
    icon: <FileCode className="w-5 h-5" />,
    color: "text-red-600",
    bgColor: "bg-red-50",
    borderColor: "border-red-500",
    attacks: [
      {
        id: "reentrancy",
        name: "Reentrancy Attack",
        severity: "Critical",
        description:
          "A vulnerability where an external contract can call back into the calling contract before the first execution is complete, allowing repeated withdrawals.",
        example:
          "The 2016 DAO hack exploited reentrancy to drain $60 million by recursively calling the withdrawal function before balance updates.",
        mitigations: [
          "Use checks-effects-interactions pattern",
          "Implement reentrancy guards (mutex locks)",
          "Use pull-payment pattern over push payments",
          "Conduct thorough security audits",
        ],
      },
      {
        id: "overflow",
        name: "Integer Overflow/Underflow",
        severity: "High",
        description:
          "Arithmetic operations exceeding maximum or minimum integer bounds, causing unexpected values and potential fund manipulation.",
        example:
          "BeautyChain (BEC) token lost $900M in value when attackers exploited an overflow bug to generate unlimited tokens.",
        mitigations: [
          "Use SafeMath libraries (pre-Solidity 0.8)",
          "Upgrade to Solidity 0.8+ with built-in checks",
          "Implement input validation",
          "Use static analysis tools",
        ],
      },
      {
        id: "flash-loan",
        name: "Flash Loan Exploits",
        severity: "Critical",
        description:
          "Uncollateralized loans enabling single-transaction attacks that manipulate prices, governance, or liquidity pools.",
        example:
          "bZx protocol lost $8M through oracle manipulation using flash loans to artificially inflate collateral values.",
        mitigations: [
          "Use time-weighted average prices (TWAP)",
          "Implement flash loan-resistant oracles",
          "Add transaction delays for sensitive operations",
          "Monitor for unusual transaction patterns",
        ],
      },
      {
        id: "access-control",
        name: "Access Control Vulnerabilities",
        severity: "High",
        description:
          "Improper permission management allowing unauthorized users to execute privileged functions.",
        example:
          "Parity wallet multi-sig vulnerability allowed anyone to become owner and self-destruct wallets, locking $300M.",
        mitigations: [
          "Use established access control patterns (OpenZeppelin)",
          "Implement role-based access control",
          "Test all permission boundaries",
          "Never use tx.origin for authorization",
        ],
      },
    ],
  },
  {
    id: "protocol",
    name: "Protocol Layer",
    description: "Consensus mechanisms and blockchain rules",
    icon: <Layers className="w-5 h-5" />,
    color: "text-orange-600",
    bgColor: "bg-orange-50",
    borderColor: "border-orange-500",
    attacks: [
      {
        id: "51-percent",
        name: "51% Attack",
        severity: "Critical",
        description:
          "When an entity controls majority computational power (PoW) or stake (PoS), enabling transaction reversal, double-spending, and transaction censorship.",
        example:
          "Ethereum Classic suffered multiple 51% attacks in 2020, with attackers double-spending over $5.6M across several incidents.",
        mitigations: [
          "Increase network hash rate / stake distribution",
          "Implement longer confirmation requirements",
          "Use checkpointing mechanisms",
          "Migrate to more secure consensus protocols",
        ],
      },
      {
        id: "selfish-mining",
        name: "Selfish Mining",
        severity: "Medium",
        description:
          "Strategic block withholding where miners delay publishing blocks to gain competitive advantage and increase relative rewards.",
        example:
          "Theoretical attack demonstrated viable at 25-33% hash power, potentially reducing honest miner revenue by 25%.",
        mitigations: [
          "Implement uniform tie-breaking rules",
          "Use timestamp-based block selection",
          "Increase block propagation speed",
          "Deploy unforgeable timestamp schemes",
        ],
      },
      {
        id: "long-range",
        name: "Long-Range Attack",
        severity: "High",
        description:
          "In PoS systems, attackers with historical stake keys create alternative chain histories from genesis, potentially rewriting entire chain.",
        example:
          "Theoretical in pure PoS systems; Ethereum 2.0 mitigates through finality gadgets and weak subjectivity checkpoints.",
        mitigations: [
          "Implement weak subjectivity checkpoints",
          "Use finality gadgets (Casper FFG)",
          "Require recent chain synchronization",
          "Combine PoS with PoW elements",
        ],
      },
    ],
  },
  {
    id: "network",
    name: "Network Layer",
    description: "Peer-to-peer communication and node connectivity",
    icon: <Network className="w-5 h-5" />,
    color: "text-amber-600",
    bgColor: "bg-amber-50",
    borderColor: "border-amber-500",
    attacks: [
      {
        id: "eclipse",
        name: "Eclipse Attack",
        severity: "High",
        description:
          "Isolating target nodes by controlling all their network connections, enabling censorship, double-spending, and selfish mining facilitation.",
        example:
          "Researchers demonstrated Bitcoin eclipse attacks requiring only 400 IP addresses to monopolize a victim's connections.",
        mitigations: [
          "Diversify peer connection sources",
          "Implement peer reputation systems",
          "Use authenticated peer discovery",
          "Monitor connection patterns for anomalies",
        ],
      },
      {
        id: "sybil",
        name: "Sybil Attack",
        severity: "High",
        description:
          "Creating multiple fake identities to gain disproportionate influence over network operations and consensus.",
        example:
          "DHT-based systems vulnerable to Sybil nodes controlling routing tables; Tor network faces similar challenges.",
        mitigations: [
          "Proof-of-Work identity costs",
          "Proof-of-Stake identity binding",
          "Trusted identity providers",
          "Social network-based trust graphs",
        ],
      },
      {
        id: "bgp-hijacking",
        name: "BGP Hijacking",
        severity: "Medium",
        description:
          "Manipulating internet routing protocols to intercept or delay blockchain traffic between nodes.",
        example:
          "2018 study found 100+ Bitcoin node prefixes susceptible to interception; attackers could delay blocks by hours.",
        mitigations: [
          "Use encrypted communications (TLS)",
          "Implement RPKI for route validation",
          "Deploy nodes across multiple ASes",
          "Monitor BGP announcements",
        ],
      },
    ],
  },
  {
    id: "infrastructure",
    name: "Infrastructure Layer",
    description: "Hardware, hosting, and physical security",
    icon: <Server className="w-5 h-5" />,
    color: "text-blue-600",
    bgColor: "bg-blue-50",
    borderColor: "border-blue-500",
    attacks: [
      {
        id: "key-compromise",
        name: "Private Key Compromise",
        severity: "Critical",
        description:
          "Theft or exposure of cryptographic private keys through malware, phishing, or physical access, enabling complete fund control.",
        example:
          "Mt. Gox lost 850,000 BTC ($450M at time) through compromised hot wallet keys; Ronin bridge lost $625M via stolen validator keys.",
        mitigations: [
          "Use hardware security modules (HSMs)",
          "Implement multi-signature schemes",
          "Air-gap cold storage for large holdings",
          "Regular key rotation policies",
        ],
      },
      {
        id: "cloud-provider",
        name: "Cloud Provider Attacks",
        severity: "Medium",
        description:
          "Exploiting centralized cloud infrastructure hosting blockchain nodes to disrupt consensus or extract sensitive data.",
        example:
          "Over 60% of Ethereum nodes run on AWS, Azure, or GCP, creating potential single points of failure.",
        mitigations: [
          "Distribute nodes across providers",
          "Use dedicated/bare-metal servers",
          "Implement geographic diversity",
          "Deploy on-premise infrastructure",
        ],
      },
      {
        id: "side-channel",
        name: "Side-Channel Attacks",
        severity: "High",
        description:
          "Extracting cryptographic secrets through timing analysis, power consumption, or electromagnetic emissions from hardware.",
        example:
          "Researchers extracted ECDSA private keys from hardware wallets through power analysis attacks.",
        mitigations: [
          "Use constant-time cryptographic implementations",
          "Deploy hardware with side-channel protections",
          "Implement power analysis countermeasures",
          "Regular security audits of hardware",
        ],
      },
    ],
  },
];

// Severity color mapping
const severityConfig = {
  Critical: {
    color: "bg-red-600 text-white",
    icon: <XCircle className="w-4 h-4" />,
  },
  High: {
    color: "bg-orange-500 text-white",
    icon: <AlertTriangle className="w-4 h-4" />,
  },
  Medium: {
    color: "bg-amber-500 text-white",
    icon: <AlertTriangle className="w-4 h-4" />,
  },
  Low: {
    color: "bg-blue-500 text-white",
    icon: <CheckCircle2 className="w-4 h-4" />,
  },
};

export function SecurityVulnerabilityTaxonomyWidget() {
  const [selectedLayer, setSelectedLayer] = useState<string | null>(null);
  const [selectedAttack, setSelectedAttack] = useState<AttackVector | null>(
    null
  );
  const [hoveredLayer, setHoveredLayer] = useState<string | null>(null);

  const activeLayer = securityLayers.find((l) => l.id === selectedLayer);

  return (
    <div className="brutalist-card p-6 md:p-8">
      {/* Header */}
      <div className="flex items-center gap-3 mb-6">
        <div className="w-10 h-10 bg-primary flex items-center justify-center">
          <Shield className="w-5 h-5 text-white" />
        </div>
        <div>
          <h5 className="font-bold text-charcoal">
            Security Vulnerability Taxonomy
          </h5>
          <p className="text-sm text-muted-foreground">
            Click a layer to explore attack vectors
          </p>
        </div>
      </div>

      {/* Main visualization area */}
      <div className="grid lg:grid-cols-2 gap-6">
        {/* Layered Stack Diagram */}
        <div className="space-y-2">
          {securityLayers.map((layer, index) => (
            <button
              key={layer.id}
              onClick={() =>
                setSelectedLayer(selectedLayer === layer.id ? null : layer.id)
              }
              onMouseEnter={() => setHoveredLayer(layer.id)}
              onMouseLeave={() => setHoveredLayer(null)}
              className={cn(
                "w-full text-left transition-all duration-300 cursor-pointer",
                "border-2 border-charcoal p-4",
                "hover:translate-x-1 hover:shadow-[4px_4px_0_#1A1A2E]",
                selectedLayer === layer.id
                  ? cn(
                      layer.bgColor,
                      "shadow-[4px_4px_0_#1A1A2E] translate-x-1"
                    )
                  : "bg-card",
                hoveredLayer === layer.id &&
                  selectedLayer !== layer.id &&
                  "bg-warm-gray"
              )}
              style={{
                marginLeft: `${index * 8}px`,
              }}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div
                    className={cn(
                      "w-8 h-8 flex items-center justify-center border-2 border-charcoal",
                      selectedLayer === layer.id
                        ? "bg-charcoal text-white"
                        : layer.bgColor
                    )}
                  >
                    {layer.icon}
                  </div>
                  <div>
                    <div className="font-semibold text-charcoal text-sm">
                      {layer.name}
                    </div>
                    <div className="text-xs text-muted-foreground hidden sm:block">
                      {layer.description}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-xs font-mono bg-charcoal text-white px-2 py-0.5">
                    {layer.attacks.length} attacks
                  </span>
                  <ChevronRight
                    className={cn(
                      "w-4 h-4 text-muted-foreground transition-transform",
                      selectedLayer === layer.id && "rotate-90"
                    )}
                  />
                </div>
              </div>
            </button>
          ))}

          {/* Legend */}
          <div className="mt-6 p-4 bg-warm-gray border-2 border-charcoal">
            <div className="text-xs font-semibold text-charcoal mb-2">
              SEVERITY LEVELS
            </div>
            <div className="flex flex-wrap gap-2">
              {(["Critical", "High", "Medium", "Low"] as const).map((level) => (
                <div key={level} className="flex items-center gap-1.5">
                  <span
                    className={cn(
                      "w-3 h-3 rounded-full",
                      level === "Critical" && "bg-red-600",
                      level === "High" && "bg-orange-500",
                      level === "Medium" && "bg-amber-500",
                      level === "Low" && "bg-blue-500"
                    )}
                  />
                  <span className="text-xs text-muted-foreground">{level}</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Attack Vectors Panel */}
        <div
          className={cn(
            "border-2 border-charcoal transition-all duration-300 min-h-[300px]",
            activeLayer ? activeLayer.bgColor : "bg-warm-gray"
          )}
        >
          {activeLayer ? (
            <div className="p-4 h-full">
              <div className="flex items-center gap-2 mb-4">
                <div
                  className={cn(
                    "w-6 h-6 flex items-center justify-center",
                    activeLayer.color
                  )}
                >
                  {activeLayer.icon}
                </div>
                <h6 className="font-bold text-charcoal">
                  {activeLayer.name} Attacks
                </h6>
              </div>

              <div className="space-y-2">
                {activeLayer.attacks.map((attack) => (
                  <button
                    key={attack.id}
                    onClick={() => setSelectedAttack(attack)}
                    className={cn(
                      "w-full text-left p-3 bg-card border-2 border-charcoal cursor-pointer",
                      "transition-all duration-200",
                      "hover:shadow-[3px_3px_0_#1A1A2E] hover:-translate-y-0.5"
                    )}
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-charcoal text-sm truncate">
                          {attack.name}
                        </div>
                        <p className="text-xs text-muted-foreground mt-1 line-clamp-2">
                          {attack.description}
                        </p>
                      </div>
                      <Badge
                        className={cn(
                          "shrink-0 text-[10px] px-1.5 py-0.5 rounded-none border-0",
                          severityConfig[attack.severity].color
                        )}
                      >
                        {attack.severity}
                      </Badge>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          ) : (
            <div className="h-full flex flex-col items-center justify-center p-6 text-center">
              <div className="w-16 h-16 bg-charcoal/10 flex items-center justify-center mb-4">
                <Shield className="w-8 h-8 text-charcoal/40" />
              </div>
              <p className="text-sm text-muted-foreground max-w-xs">
                Select a security layer from the left to view associated attack
                vectors and vulnerabilities
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Attack Detail Modal */}
      <Dialog
        open={selectedAttack !== null}
        onOpenChange={() => setSelectedAttack(null)}
      >
        <DialogContent className="sm:max-w-lg border-2 border-charcoal rounded-none shadow-[6px_6px_0_#1A1A2E]">
          {selectedAttack && (
            <>
              <DialogHeader>
                <div className="flex items-start justify-between gap-4">
                  <div className="flex-1">
                    <DialogTitle className="text-charcoal text-lg">
                      {selectedAttack.name}
                    </DialogTitle>
                    <DialogDescription className="mt-1">
                      {activeLayer?.name} vulnerability
                    </DialogDescription>
                  </div>
                  <Badge
                    className={cn(
                      "shrink-0 rounded-none border-0 gap-1.5",
                      severityConfig[selectedAttack.severity].color
                    )}
                  >
                    {severityConfig[selectedAttack.severity].icon}
                    {selectedAttack.severity}
                  </Badge>
                </div>
              </DialogHeader>

              <div className="space-y-4 mt-2">
                {/* Description */}
                <div>
                  <h6 className="text-xs font-semibold text-charcoal uppercase tracking-wider mb-2">
                    Description
                  </h6>
                  <p className="text-sm text-muted-foreground leading-relaxed">
                    {selectedAttack.description}
                  </p>
                </div>

                {/* Example */}
                {selectedAttack.example && (
                  <div className="p-3 bg-warm-gray border-l-4 border-primary">
                    <h6 className="text-xs font-semibold text-charcoal uppercase tracking-wider mb-1.5">
                      Real-World Example
                    </h6>
                    <p className="text-sm text-muted-foreground">
                      {selectedAttack.example}
                    </p>
                  </div>
                )}

                {/* Mitigations */}
                <div>
                  <h6 className="text-xs font-semibold text-charcoal uppercase tracking-wider mb-2 flex items-center gap-2">
                    <CheckCircle2 className="w-4 h-4 text-green-600" />
                    Mitigation Strategies
                  </h6>
                  <ul className="space-y-1.5">
                    {selectedAttack.mitigations.map((mitigation, index) => (
                      <li
                        key={index}
                        className="flex items-start gap-2 text-sm text-muted-foreground"
                      >
                        <span className="w-1.5 h-1.5 bg-primary rounded-full mt-2 shrink-0" />
                        {mitigation}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
